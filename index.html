<!DOCTYPE html>
<html lang="mn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Letter</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #1c1917;
            font-family: 'Times New Roman', Times, serif;
            touch-action: none;
        }

        /* Simplified Sway for better performance */
        @keyframes gentleSway {
            0%, 100% { transform: rotate(0deg); }
            50% { transform: rotate(1deg); }
        }

        .envelope-sway:hover:not(.open) {
            animation: gentleSway 3s ease-in-out infinite;
        }
        
        .is-holding:not(.open) {
            animation: gentleSway 1s ease-in-out infinite !important;
        }

        .letter-reveal {
            transition: all 1.2s ease-out;
            will-change: transform, opacity;
        }
        
        .paper-clean {
            background-color: #fdfcf9;
        }
        
        .custom-scroll::-webkit-scrollbar {
            width: 4px;
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background: rgba(0,0,0,0.1);
            border-radius: 4px;
        }

        .no-tap-highlight {
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        .word-paragraph {
            text-indent: 2em;
            text-align: justify;
            line-height: 1.6;
            margin-bottom: 1.2em;
            /* Uniform font size */
            font-size: 18px;
            color: #444;
        }

        .final-inquiry {
            text-align: center;
            text-indent: 0;
            margin-top: 2em;
            padding-bottom: 4em;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const App = () => {
            const [isCompleted, setIsCompleted] = useState(false);
            const [isSealPopped, setIsSealPopped] = useState(false);
            const [isOpen, setIsOpen] = useState(false);
            const [showLetter, setShowLetter] = useState(false);
            const [isSettled, setIsSettled] = useState(false);
            const [holdProgress, setHoldProgress] = useState(0);
            const [isHolding, setIsHolding] = useState(false);
            
            const stateRef = useRef({ holding: false, progress: 0 });
            const sealRef = useRef(null);
            const lastTimeRef = useRef(performance.now());

            const paragraphs = [
                `Хамгийн эхлээд хайрт чамаасаа уучлалт хүсье, бас баярласан сэтгэлээ илэрхийлье. Анх 2023 оны өвөл чамайг Хайраа багшийн олимпиадын бэлтгэл дээр харж байлаа...`,
                `Тэгээд хичээл ороод Хайраа багшийн давтлагад нь туслах багш хийж байхдаа, 9-ийн и-ийн хүүхдүүд гэж мэдээд чамайг суухгүй юм байх даа гэж нэлээд хүсэж хүлээж байсан...`,
                `Дараа нь дуу хуур, бүжиг цэнгүүн дуусаад тэр хавиар хийцгүйрч явж байгаад заал руу нь орсон чинь танай ангийнхан ангиараа зургаа авахуулж байхад нь таараад...`,
                `Тэгээд 10-р анги эхэлж чамайг ангид байгааг мэдээд бага багаар ажиглаж эхэлсэн… өрсөлдөгч гэж харсаар бусад хичээлдээ ч сайн гэдгийг чинь...`,
                `Дараа нь химийн хичээл/цаг дээр цуг суугаад л, эхэндээ чамайг Мичидмаатай юм яриад эсвэл хичээлээ чимээгүйхэн хийхийг чинь хааяа даа хардаг байгаад...`,
                `Харин чамтайгаа анх удаагаа ярилцаж үзсэн нь энэ зун 7-р сарын 4-нд, ээж хагалгааны өрөө рүүгээ орчихоор нь гадаа нь хүлээж суунгаа...`,
                `Ээж ч эмнэлгээсээ гараад, гэртээ хариад яагаад ч юм чамтай дахин дахин ярилцахын хүслэн болсоор нэгэн аргыг сэдэв ээ. Чамаар зураг зуруулах нэрийдлээр...`,
                `Харин анх удаагаа чамд санаа зовсон минь бол, dude гэж их л сандарсан байдалтай зүг асуухад чинь...`,
                `8-р сарын сүүл болж өдөр болгон шахуу чамтайгаа ярилцсаар хичээл орлоо, 9-н сарын 1-нд тэр олон дундаас чамайг олж харчихаад...`,
                `Тэр орой нь чиний минь тавьсан note-ийг хараад “өөр залууд зориулсан бол яах вэ?”, “хэрвээ надад зориулсан бол...” гэж босоор сэтгэл зориглон чамд сэтгэлээ илчиллээ...`,
                `Чамтайгаа үерхэж эхлээд гомдоохгүй юм сан, алдчихгүй юм сан гэж айсаар алдаа гаргаад тэдгээрийгэа мэдсэн ч засаж чадалгүй...`,
                `Иймээс хайр нь болоогүй ирээдүйд биш зөвхөн чамдаа анхаарч, сэтгэл зүйгээ ч бас тогтвортой байлганаа...`,
                `Би өөрийгөө засаад гэсэн ч гэлээ, алдаагаа, буруу хийсэн зүйлсээ засаж байгаа болохоор, би “би” хэвээрээ л байх болохоор чамд минь санаа зовох зүйл байхгүй ээ.`
            ];

            const handleStart = () => { if (!isCompleted) { stateRef.current.holding = true; setIsHolding(true); } };
            const handleEnd = () => { stateRef.current.holding = false; setIsHolding(false); };

            useEffect(() => {
                let frame;
                const loop = (time) => {
                    const dt = time - lastTimeRef.current;
                    lastTimeRef.current = time;
                    if (stateRef.current.holding && !isCompleted) {
                        stateRef.current.progress = Math.min(100, stateRef.current.progress + (dt * 0.1));
                        setHoldProgress(stateRef.current.progress);
                        if (stateRef.current.progress >= 100) {
                            setIsCompleted(true); setIsHolding(false);
                            setTimeout(() => setIsSealPopped(true), 300);
                        }
                    } else if (!isCompleted && stateRef.current.progress > 0) {
                        stateRef.current.progress = Math.max(0, stateRef.current.progress - (dt * 0.2));
                        setHoldProgress(stateRef.current.progress);
                    }
                    frame = requestAnimationFrame(loop);
                };
                frame = requestAnimationFrame(loop);
                return () => cancelAnimationFrame(frame);
            }, [isCompleted]);

            useEffect(() => {
                if (isSealPopped) {
                    setTimeout(() => { setIsOpen(true); }, 200);
                }
            }, [isSealPopped]);

            useEffect(() => {
                if (isOpen) {
                    setTimeout(() => { setShowLetter(true); setTimeout(() => setIsSettled(true), 1200); }, 500);
                }
            }, [isOpen]);

            const circumference = 2 * Math.PI * 45;
            const strokeDashoffset = circumference - (holdProgress / 100) * circumference;

            return (
                <div className="fixed inset-0 flex items-center justify-center bg-[#1c1917] overflow-hidden no-tap-highlight">
                    
                    <div className={`relative w-[300px] h-[200px] transition-transform duration-1000 envelope-sway
                        ${isOpen ? 'translate-y-[35vh] scale-50' : ''} ${isHolding ? 'is-holding' : ''}`}>
                        
                        {/* Envelope Body */}
                        <div className="absolute inset-0 bg-[#8b1e1e] rounded shadow-xl z-20 overflow-hidden">
                            <div className="absolute inset-0 bg-[#7a1515]" style={{ clipPath: 'polygon(0% 0%, 50% 50%, 100% 0%, 100% 100%, 0% 100%)' }} />
                        </div>

                        {/* Flap */}
                        <div className="absolute top-0 w-full h-full bg-[#9c2525] origin-top transition-transform duration-1000 z-40"
                             style={{ clipPath: 'polygon(0% 0%, 100% 0%, 50% 50%)', transform: isOpen ? 'rotateX(180deg)' : 'rotateX(0deg)' }} />

                        {/* Letter */}
                        <div className={`absolute left-1/2 -translate-x-1/2 paper-clean shadow-2xl letter-reveal
                            ${isSettled 
                                ? 'fixed top-0 translate-y-[2vh] w-[94vw] h-[96vh] z-[100] scale-100 p-6' 
                                : showLetter ? 'opacity-100 -translate-y-full w-[260px] h-[300px] z-10' : 'opacity-0 w-20 h-10'}`}>
                            
                            <div className="h-full overflow-y-auto custom-scroll px-2">
                                {paragraphs.map((p, i) => (
                                    <p key={i} className="word-paragraph">{p}</p>
                                ))}
                                <div className="final-inquiry">
                                    <p className="font-bold text-xl text-black">Хүслээ, намайг чиний найз залуу болохыг зөвшөөрч байна уу?</p>
                                </div>
                            </div>
                        </div>

                        {/* Seal */}
                        {!isSealPopped && (
                            <div 
                                onMouseDown={handleStart} onTouchStart={handleStart} 
                                onMouseUp={handleEnd} onTouchEnd={handleEnd}
                                className="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 z-[50] cursor-pointer">
                                <svg width="100" height="100" viewBox="0 0 100 100" className="-rotate-90">
                                    <circle cx="50" cy="50" r="45" fill="none" stroke="rgba(255,255,255,0.1)" strokeWidth="4" />
                                    <circle cx="50" cy="50" r="45" fill="none" stroke="#ffb7c5" strokeWidth="4" 
                                            strokeDasharray={circumference} strokeDashoffset={strokeDashoffset} />
                                </svg>
                                <div className="absolute inset-0 flex items-center justify-center">
                                    <div className="w-14 h-14 bg-pink-600 rounded-full shadow-inner" />
                                </div>
                            </div>
                        )}
                    </div>

                    {!isOpen && (
                        <div className="fixed bottom-10 w-full text-center text-stone-500 uppercase tracking-widest text-[10px]">
                            Hold Seal to Open
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
